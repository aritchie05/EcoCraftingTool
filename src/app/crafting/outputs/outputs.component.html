<div class="flex flex-col items-center mx-8">
  <h1 class="text-4xl my-1">Outputs</h1>
  <mat-form-field appearance="outline" floatLabel="always" class="w-full my-1">
    <mat-label>Choose a recipe</mat-label>
    <input #recipeInput matInput type="text" (input)="onRecipeInput(recipeInput.value)"
           [matAutocomplete]="recipesAutocomplete">
  </mat-form-field>
  <mat-autocomplete #recipesAutocomplete="matAutocomplete" class="max-h-[70vh]"
                    (optionSelected)="onRecipeSelected($event.option, recipeInput)">
    @for (recipe of filteredRecipes; track recipe.nameID) {
      <mat-option [value]="recipe">
        {{ recipe.name() }}
      </mat-option>
    }
  </mat-autocomplete>
  <div class="flex flex-col w-full text-sm selected-outputs-container my-1">
    @for (displayGroup of groupedDisplayKeys(); track displayGroup) {
      <mat-expansion-panel togglePosition="before" expanded class="my-1">
        <mat-expansion-panel-header>
          <mat-panel-title>{{ displayGroup.name() }}</mat-panel-title>
          <mat-icon (click)="onRemoveSkill(displayGroup)">close</mat-icon>
        </mat-expansion-panel-header>
        @for (outputDisplay of groupedOutputDisplays().get(displayGroup); track outputDisplay.itemNameID) {
          <div class="output-container my-1 pl-1 py-2 rounded">
            <div class="flex flex-row items-center w-full">
              <img [src]="imageService.imageTemplateUrl" [style]="imageService.getOutputImgStyle(outputDisplay)"
                   width="32" height="32" [alt]="outputDisplay.itemName() + ' icon'" class="mr-2">
              <span class="font-medium">
                {{ outputDisplay.itemName() }}
              </span>
              @if (outputDisplay.subRecipes.length === 1) {
                <button class="material-icons cursor-pointer hover:opacity-80 ml-1"
                        (click)="onRecipeInfoClick(outputDisplay.subRecipes[0])">info_outline
                </button>
              }
              <div class="ml-auto flex items-center">
                <mat-form-field appearance="outline" class="w-24 mr-4">
                  <mat-label>Base Cost</mat-label>
                  <input #basePrice matInput type="text" readonly class="cursor-not-allowed"
                         [value]="outputDisplay.basePrice().toLocaleString(localeService.selectedLocale().code,
                   {maximumFractionDigits: 2, minimumFractionDigits: 0})">
                </mat-form-field>
                <mat-form-field appearance="outline" floatLabel="always" class="w-24 mr-4">
                  <mat-label>Profit</mat-label>
                  <input #profitOverride matInput type="number" min="0" step="1" class="profit-input"
                         [value]="outputDisplay.subRecipes[0].recipe.profitOverride() >= 0 ? outputDisplay.subRecipes[0].recipe.profitOverride() : defaultProfitPercent()"
                         (focusout)="onProfitOverrideChange(profitOverride.value, outputDisplay)"
                  >
                  <span matSuffix>%</span>
                </mat-form-field>
                <mat-form-field appearance="outline" class="w-24 mr-4">
                  <mat-label>Sale Price</mat-label>
                  <input #outputCost matInput type="text" readonly class="cursor-not-allowed"
                         [value]="outputDisplay.itemPrice().toLocaleString(localeService.selectedLocale().code,
                   {maximumFractionDigits: 2, minimumFractionDigits: 0})">
                </mat-form-field>
                <button class="material-icons cursor-pointer hover:opacity-80 mr-2"
                        (click)="onRemoveOutput(outputDisplays().indexOf(outputDisplay))">
                  close
                </button>
              </div>
            </div>
            @if (outputDisplay.subRecipes.length > 1) {
              @for (subRecipe of outputDisplay.subRecipes; track subRecipe.recipeNameID; let subIndex = $index) {
                <div class="flex flex-row items-center w-full pl-8 mt-3">
                  <span class="pl-6">
                    {{ subRecipe.recipeName() }} Recipe
                  </span>
                  <button class="material-icons cursor-pointer hover:opacity-80 ml-1"
                          (click)="onRecipeInfoClick(subRecipe)">
                    info_outline
                  </button>
                  <div class="ml-auto flex items-center">
                    <mat-form-field appearance="outline" class="w-24 mr-4">
                      <mat-label>Cost</mat-label>
                      <input #subRecipeBasePrice matInput type="text" readonly class="cursor-not-allowed"
                             [value]="subRecipe.basePrice().toLocaleString(localeService.selectedLocale().code,
                     {maximumFractionDigits: 2, minimumFractionDigits: 0})">
                    </mat-form-field>
                    <button class="material-icons cursor-pointer hover:opacity-80 mr-2"
                            (click)="onRemoveSubRecipe(outputDisplays().indexOf(outputDisplay), subIndex)">
                      close
                    </button>
                  </div>
                </div>
              }
            }
          </div>
        }
      </mat-expansion-panel>
    }
    <!--
    @for (outputDisplay of outputDisplays(); track outputDisplay.itemNameID; let outputIndex = $index) {
      <div class="output-container my-1 pl-1 py-2 rounded">
        <div class="flex flex-row flex-wrap items-center w-full">
          <img [src]="imageService.imageTemplateUrl" [style]="imageService.getOutputImgStyle(outputDisplay)"
               width="32" height="32" [alt]="outputDisplay.itemName() + ' icon'" class="mr-2">
          <label [for]="outputCost.id" class="font-medium">
            {{ outputDisplay.itemName() }}
          </label>
          @if (outputDisplay.subRecipes.length === 1) {
            <button class="material-icons cursor-pointer hover:opacity-80 ml-1"
                    (click)="onRecipeInfoClick(outputDisplay.subRecipes[0])">info_outline</button>
          }
          <div class="ml-auto flex items-center">
            <mat-form-field appearance="outline" class="w-24 mr-4">
              <input #outputCost matInput type="text" readonly class="cursor-not-allowed"
                     [value]="outputDisplay.itemPrice().toLocaleString(localeService.selectedLocale().code,
                 {maximumFractionDigits: 2, minimumFractionDigits: 0})">
            </mat-form-field>
            <button class="material-icons cursor-pointer hover:opacity-80 mr-2"
                    (click)="onRemoveOutput(outputIndex)">
              close
            </button>
          </div>
        </div>
        @if (outputDisplay.subRecipes.length > 1) {
          @for (subRecipe of outputDisplay.subRecipes; track subRecipe.recipeNameID; let subIndex = $index) {
            <div class="flex flex-row flex-wrap items-center w-full pl-8 mt-1">
              <label class="pl-6" [for]="subRecipePrice.id">
                {{ subRecipe.recipeName() }} Recipe
              </label>
              <button class="material-icons cursor-pointer hover:opacity-80 ml-1"
                      (click)="onRecipeInfoClick(subRecipe)">
                info_outline
              </button>
              <div class="ml-auto flex items-center">
                <mat-form-field appearance="outline" class="w-24 mr-4">
                  <input #subRecipePrice matInput type="text" readonly class="cursor-not-allowed"
                         [value]="subRecipe.recipePrice().toLocaleString(localeService.selectedLocale().code,
                   {maximumFractionDigits: 2, minimumFractionDigits: 0})">
                </mat-form-field>
                <button class="material-icons cursor-pointer hover:opacity-80 mr-2"
                        (click)="onRemoveSubRecipe(outputIndex, subIndex)">
                  close
                </button>
              </div>
            </div>
          }
        }
      </div>
    }
    -->
    </div>
</div>
